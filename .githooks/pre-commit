#!/bin/bash
# Pre-commit hook: PHP syntax check
# Install: git config core.hooksPath .githooks

echo "Running PHP syntax check on staged files..."

ERRORS=0

# Get list of staged PHP files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.php$')

if [ -z "$STAGED_FILES" ]; then
    echo "No PHP files staged for commit."
    exit 0
fi

# Check if php is available
if ! command -v php &> /dev/null; then
    echo "WARNING: PHP not found locally. Skipping syntax check."
    echo "Install PHP or use Docker for testing."
    exit 0
fi

# Check each staged PHP file for syntax errors
for FILE in $STAGED_FILES; do
    if [ -f "$FILE" ]; then
        OUTPUT=$(php -l "$FILE" 2>&1)
        if [ $? -ne 0 ]; then
            echo "SYNTAX ERROR in $FILE:"
            echo "$OUTPUT"
            ERRORS=$((ERRORS + 1))
        fi
    fi
done

if [ $ERRORS -gt 0 ]; then
    echo ""
    echo "COMMIT BLOCKED: $ERRORS file(s) with PHP syntax errors."
    echo "Fix the errors above before committing."
    exit 1
fi

echo "PHP syntax check passed for $(echo "$STAGED_FILES" | wc -l | tr -d ' ') file(s)."
exit 0
