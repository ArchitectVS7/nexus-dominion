#!/bin/bash
# Pre-push hook: Docker build test
# Install: git config core.hooksPath .githooks

echo "Running pre-push Docker build test..."

# Check if docker is available
if ! command -v docker &> /dev/null; then
    echo "WARNING: Docker not found. Skipping build test."
    echo "Consider installing Docker Desktop for local testing."
    exit 0
fi

# Check if Docker daemon is running
if ! docker info &> /dev/null; then
    echo "WARNING: Docker daemon not running. Skipping build test."
    echo "Start Docker Desktop for local testing."
    exit 0
fi

echo "Building Docker image (this may take a minute)..."

# Build the web image
if ! docker compose build web 2>&1 | tail -20; then
    echo ""
    echo "PUSH BLOCKED: Docker build failed."
    echo "Fix the build errors above before pushing."
    exit 1
fi

echo ""
echo "Docker build successful. Starting containers for smoke test..."

# Start containers in detached mode
docker compose up -d

# Wait for containers to be healthy
echo "Waiting for containers to be ready..."
sleep 10

# Check if web container is running
if ! docker compose ps web | grep -q "Up"; then
    echo "PUSH BLOCKED: Web container failed to start."
    docker compose logs web | tail -30
    docker compose down
    exit 1
fi

# Basic HTTP check
HTTP_CODE=$(docker compose exec -T web curl -s -o /dev/null -w "%{http_code}" http://localhost/ 2>/dev/null || echo "000")

if [ "$HTTP_CODE" = "000" ]; then
    # curl might not be in container, try wget
    HTTP_CODE=$(docker compose exec -T web wget -q -O /dev/null --server-response http://localhost/ 2>&1 | grep "HTTP/" | tail -1 | awk '{print $2}' || echo "000")
fi

# Clean up
docker compose down

if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "302" ]; then
    echo ""
    echo "Pre-push tests passed! HTTP response: $HTTP_CODE"
    exit 0
else
    echo ""
    echo "WARNING: HTTP smoke test returned $HTTP_CODE (expected 200 or 302)"
    echo "This may be expected if database isn't initialized."
    echo "Proceeding with push anyway..."
    exit 0
fi
